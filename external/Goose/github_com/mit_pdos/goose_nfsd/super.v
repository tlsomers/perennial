(* autogenerated from github.com/mit-pdos/goose-nfsd/super *)
From Perennial.goose_lang Require Import prelude.
From Perennial.goose_lang Require Import ffi.disk_prelude.

From Goose Require github_com.mit_pdos.goose_nfsd.addr.
From Goose Require github_com.mit_pdos.goose_nfsd.common.
From Goose Require github_com.mit_pdos.goose_nfsd.fake_bcache.bcache.
From Goose Require github_com.mit_pdos.goose_nfsd.util.

Module FsSuper.
  Definition S := struct.decl [
    "Disk" :: struct.ptrT bcache.Bcache.S;
    "Size" :: uint64T;
    "nLog" :: uint64T;
    "NBlockBitmap" :: uint64T;
    "NInodeBitmap" :: uint64T;
    "nInodeBlk" :: uint64T;
    "Maxaddr" :: uint64T
  ].
End FsSuper.

Definition MkFsSuper: val :=
  λ: "sz" "name",
    let: "nblockbitmap" := "sz" `quot` common.NBITBLOCK + #1 in
    let: "d" := ref (zero_val Disk) in
    (if: "name" ≠ slice.nil
    then
      util.DPrintf #0 (#(str"MkFsSuper: open file disk %s
      ")) (![stringT] "name");;
      let: ("file", "err") := disk.NewFileDisk (![stringT] "name") "sz" in
      (if: "err" ≠ slice.nil
      then
        Panic ("MkFsSuper: couldn't create disk image");;
        #()
      else #());;
      "d" <-[Disk] "file"
    else
      util.DPrintf #0 (#(str"MkFsSuper: create mem disk
      "));;
      "d" <-[Disk] disk.NewMemDisk "sz");;
    let: "bc" := bcache.MkBcache (![Disk] "d") in
    struct.new FsSuper.S [
      "Disk" ::= "bc";
      "Size" ::= "sz";
      "nLog" ::= common.LOGSIZE;
      "NBlockBitmap" ::= "nblockbitmap";
      "NInodeBitmap" ::= common.NINODEBITMAP;
      "nInodeBlk" ::= common.NINODEBITMAP * common.NBITBLOCK * common.INODESZ `quot` disk.BlockSize;
      "Maxaddr" ::= "sz"
    ].

Definition FsSuper__MaxBnum: val :=
  λ: "fs",
    struct.loadF FsSuper.S "Maxaddr" "fs".

Definition FsSuper__BitmapBlockStart: val :=
  λ: "fs",
    struct.loadF FsSuper.S "nLog" "fs".

Definition FsSuper__BitmapInodeStart: val :=
  λ: "fs",
    FsSuper__BitmapBlockStart "fs" + struct.loadF FsSuper.S "NBlockBitmap" "fs".

Definition FsSuper__InodeStart: val :=
  λ: "fs",
    FsSuper__BitmapInodeStart "fs" + struct.loadF FsSuper.S "NInodeBitmap" "fs".

Definition FsSuper__DataStart: val :=
  λ: "fs",
    FsSuper__InodeStart "fs" + struct.loadF FsSuper.S "nInodeBlk" "fs".

Definition FsSuper__Block2addr: val :=
  λ: "fs" "blkno",
    addr.MkAddr "blkno" #0 common.NBITBLOCK.

Definition FsSuper__NInode: val :=
  λ: "fs",
    struct.loadF FsSuper.S "nInodeBlk" "fs" * common.INODEBLK.

Definition FsSuper__Inum2Addr: val :=
  λ: "fs" "inum",
    addr.MkAddr (FsSuper__InodeStart "fs" + "inum" `quot` common.INODEBLK) ("inum" `rem` common.INODEBLK * common.INODESZ * #8) (common.INODESZ * #8).

Definition FsSuper__DiskBlockSize: val :=
  λ: "fs" "addr",
    (struct.get addr.Addr.S "Sz" "addr" = common.NBITBLOCK).
