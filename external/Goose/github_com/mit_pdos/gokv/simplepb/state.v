(* autogenerated from github.com/mit-pdos/gokv/simplepb/state *)
From Perennial.goose_lang Require Import prelude.
From Goose Require github_com.mit_pdos.gokv.simplepb.e.
From Goose Require github_com.mit_pdos.gokv.simplepb.pb.
From Goose Require github_com.tchajed.marshal.

From Perennial.goose_lang Require Import ffi.grove_prelude.

(* client.go *)

(* XXX: has to be bigger than all pb RPCs *)
Definition RPC_FAA : expr := #5.

Definition Clerk := struct.decl [
  "cl" :: ptrT
].

Definition MakeClerk: val :=
  rec: "MakeClerk" "host" :=
    struct.new Clerk [
      "cl" ::= pb.MakeClerk "host"
    ].

Definition Clerk__FetchAndAppend: val :=
  rec: "Clerk__FetchAndAppend" "ck" "key" "val" :=
    let: "args" := ref_to (slice.T byteT) (NewSliceWithCap byteT #0 (#8 + slice.len "val")) in
    "args" <-[slice.T byteT] marshal.WriteInt (![slice.T byteT] "args") "key";;
    "args" <-[slice.T byteT] marshal.WriteBytes (![slice.T byteT] "args") "val";;
    pb.Clerk__PrimaryApply (struct.loadF Clerk "cl" "ck") (![slice.T byteT] "args").

(* example.go *)

Definition KVState := struct.decl [
  "kvs" :: mapT (slice.T byteT);
  "filename" :: stringT;
  "epoch" :: uint64T;
  "nextIndex" :: uint64T
].

Definition Op: ty := slice.T byteT.

Definition KVState__loadState: val :=
  rec: "KVState__loadState" "s" "snap_in" :=
    (* log.Println("Loading encoded state: ", len(snap_in)) *)
    let: "snap" := ref_to (slice.T byteT) "snap_in" in
    struct.storeF KVState "kvs" "s" (NewMap (slice.T byteT) #());;
    let: ("numEntries", "snap") := marshal.ReadInt (![slice.T byteT] "snap") in
    let: "i" := ref_to uint64T #0 in
    (for: (位: <>, ![uint64T] "i" < "numEntries"); (位: <>, "i" <-[uint64T] ![uint64T] "i" + #1) := 位: <>,
      let: "key" := ref (zero_val uint64T) in
      let: "valLen" := ref (zero_val uint64T) in
      let: "val" := ref (zero_val (slice.T byteT)) in
      let: ("0_ret", "1_ret") := marshal.ReadInt (![slice.T byteT] "snap") in
      "key" <-[uint64T] "0_ret";;
      "snap" <-[slice.T byteT] "1_ret";;
      let: ("0_ret", "1_ret") := marshal.ReadInt (![slice.T byteT] "snap") in
      "valLen" <-[uint64T] "0_ret";;
      "snap" <-[slice.T byteT] "1_ret";;
      "val" <-[slice.T byteT] SliceTake (![slice.T byteT] "snap") (![uint64T] "valLen");;
      "snap" <-[slice.T byteT] SliceSkip byteT (![slice.T byteT] "snap") (![uint64T] "valLen");;
      MapInsert (struct.loadF KVState "kvs" "s") (![uint64T] "key") (![slice.T byteT] "val");;
      Continue);;
    #().

Definition RecoverKVState: val :=
  rec: "RecoverKVState" "fname" :=
    let: "s" := struct.alloc KVState (zero_val (struct.t KVState)) in
    let: "encState" := ref_to (slice.T byteT) (grove_ffi.Read "fname") in
    struct.storeF KVState "filename" "s" "fname";;
    (if: (slice.len (![slice.T byteT] "encState") = #0)
    then
      struct.storeF KVState "epoch" "s" #0;;
      struct.storeF KVState "nextIndex" "s" #0;;
      struct.storeF KVState "kvs" "s" (NewMap (slice.T byteT) #())
    else
      let: ("0_ret", "1_ret") := marshal.ReadInt (![slice.T byteT] "encState") in
      struct.storeF KVState "epoch" "s" "0_ret";;
      "encState" <-[slice.T byteT] "1_ret";;
      let: ("0_ret", "1_ret") := marshal.ReadInt (![slice.T byteT] "encState") in
      struct.storeF KVState "nextIndex" "s" "0_ret";;
      "encState" <-[slice.T byteT] "1_ret";;
      KVState__loadState "s" (![slice.T byteT] "encState"));;
    "s".

Definition KVState__GetState: val :=
  rec: "KVState__GetState" "s" :=
    let: "enc" := ref_to (slice.T byteT) (NewSlice byteT #0) in
    "enc" <-[slice.T byteT] marshal.WriteInt (![slice.T byteT] "enc") (MapLen (struct.loadF KVState "kvs" "s"));;
    MapIter (struct.loadF KVState "kvs" "s") (位: "k" "v",
      "enc" <-[slice.T byteT] marshal.WriteInt (![slice.T byteT] "enc") "k";;
      "enc" <-[slice.T byteT] marshal.WriteInt (![slice.T byteT] "enc") (slice.len "v");;
      "enc" <-[slice.T byteT] marshal.WriteBytes (![slice.T byteT] "enc") "v");;
    (* log.Println("Size of encoded state", len(enc)) *)
    ![slice.T byteT] "enc".

Definition KVState__MakeDurable: val :=
  rec: "KVState__MakeDurable" "s" :=
    let: "state" := KVState__GetState "s" in
    let: "enc" := ref_to (slice.T byteT) (NewSliceWithCap byteT #0 (#16 + slice.len "state")) in
    "enc" <-[slice.T byteT] marshal.WriteInt (![slice.T byteT] "enc") (struct.loadF KVState "epoch" "s");;
    "enc" <-[slice.T byteT] marshal.WriteInt (![slice.T byteT] "enc") (struct.loadF KVState "nextIndex" "s");;
    "enc" <-[slice.T byteT] marshal.WriteBytes (![slice.T byteT] "enc") "state";;
    grove_ffi.Write (struct.loadF KVState "filename" "s") (![slice.T byteT] "enc");;
    #().

Definition KVState__Apply: val :=
  rec: "KVState__Apply" "s" "op" :=
    let: ("key", "appendVal") := marshal.ReadInt "op" in
    let: "ret" := Fst (MapGet (struct.loadF KVState "kvs" "s") "key") in
    struct.storeF KVState "nextIndex" "s" (struct.loadF KVState "nextIndex" "s" + #1);;
    MapInsert (struct.loadF KVState "kvs" "s") "key" (SliceAppendSlice byteT (Fst (MapGet (struct.loadF KVState "kvs" "s") "key")) "appendVal");;
    KVState__MakeDurable "s";;
    "ret".

Definition KVState__SetState: val :=
  rec: "KVState__SetState" "s" "snap_in" :=
    KVState__loadState "s" "snap_in";;
    KVState__MakeDurable "s";;
    #().

Definition KVState__EnterEpoch: val :=
  rec: "KVState__EnterEpoch" "s" "epoch" :=
    struct.storeF KVState "epoch" "s" "epoch";;
    KVState__MakeDurable "s";;
    #().

Definition MakeKVStateMachine: val :=
  rec: "MakeKVStateMachine" "initState" :=
    struct.new pb.StateMachine [
      "Apply" ::= KVState__Apply "initState";
      "SetState" ::= KVState__SetState "initState";
      "GetState" ::= KVState__GetState "initState";
      "EnterEpoch" ::= KVState__EnterEpoch "initState"
    ].

Definition KVServer := struct.decl [
  "r" :: ptrT
].

Definition MakeServer: val :=
  rec: "MakeServer" "fname" :=
    let: "s" := struct.alloc KVServer (zero_val (struct.t KVServer)) in
    let: "epoch" := ref (zero_val uint64T) in
    let: "nextIndex" := ref (zero_val uint64T) in
    let: "state" := RecoverKVState "fname" in
    struct.storeF KVServer "r" "s" (pb.MakeServer (MakeKVStateMachine "state") (![uint64T] "nextIndex") (![uint64T] "epoch"));;
    "s".

Definition KVServer__Serve: val :=
  rec: "KVServer__Serve" "s" "me" :=
    pb.Server__Serve (struct.loadF KVServer "r" "s") "me";;
    #().
