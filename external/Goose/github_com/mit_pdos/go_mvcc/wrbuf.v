(* autogenerated from github.com/mit-pdos/go-mvcc/wrbuf *)
From Perennial.goose_lang Require Import prelude.

Section code.
Context `{ext_ty: ext_types}.
Local Coercion Var' s: expr := Var s.

Definition WrEnt := struct.decl [
  "key" :: uint64T;
  "val" :: uint64T;
  "del" :: boolT
].

Definition WrBuf := struct.decl [
  "ents" :: slice.T (struct.t WrEnt)
].

Definition WrBuf__lookup: val :=
  rec: "WrBuf__lookup" "wrbuf" "key" :=
    let: "pos" := ref_to uint64T #0 in
    Skip;;
    (for: (λ: <>, #true); (λ: <>, Skip) := λ: <>,
      (if: ![uint64T] "pos" ≥ slice.len (struct.loadF WrBuf "ents" "wrbuf")
      then Break
      else
        (if: ("key" = struct.get WrEnt "key" (SliceGet (struct.t WrEnt) (struct.loadF WrBuf "ents" "wrbuf") (![uint64T] "pos")))
        then Break
        else
          "pos" <-[uint64T] ![uint64T] "pos" + #1;;
          Continue)));;
    let: "found" := ![uint64T] "pos" < slice.len (struct.loadF WrBuf "ents" "wrbuf") in
    (![uint64T] "pos", "found").

Definition WrBuf__Lookup: val :=
  rec: "WrBuf__Lookup" "wrbuf" "key" :=
    let: ("pos", "found") := WrBuf__lookup "wrbuf" "key" in
    (if: "found"
    then
      let: "ent" := SliceGet (struct.t WrEnt) (struct.loadF WrBuf "ents" "wrbuf") "pos" in
      (struct.get WrEnt "val" "ent", struct.get WrEnt "del" "ent", #true)
    else (#0, #false, #false)).

Definition WrBuf__Put: val :=
  rec: "WrBuf__Put" "wrbuf" "key" "val" :=
    let: ("pos", "found") := WrBuf__lookup "wrbuf" "key" in
    (if: "found"
    then
      let: "went" := SliceRef (struct.t WrEnt) (struct.loadF WrBuf "ents" "wrbuf") "pos" in
      struct.storeF WrEnt "val" "went" "val";;
      struct.storeF WrEnt "del" "went" #false;;
      #()
    else
      let: "ent" := struct.mk WrEnt [
        "key" ::= "key";
        "val" ::= "val";
        "del" ::= #false
      ] in
      struct.storeF WrBuf "ents" "wrbuf" (SliceAppend (struct.t WrEnt) (struct.loadF WrBuf "ents" "wrbuf") "ent");;
      #()).

Definition WrBuf__Delete: val :=
  rec: "WrBuf__Delete" "wrbuf" "key" :=
    let: ("pos", "found") := WrBuf__lookup "wrbuf" "key" in
    (if: "found"
    then
      let: "went" := SliceRef (struct.t WrEnt) (struct.loadF WrBuf "ents" "wrbuf") "pos" in
      struct.storeF WrEnt "del" "went" #true;;
      #()
    else
      let: "ent" := struct.mk WrEnt [
        "key" ::= "key";
        "del" ::= #true
      ] in
      struct.storeF WrBuf "ents" "wrbuf" (SliceAppend (struct.t WrEnt) (struct.loadF WrBuf "ents" "wrbuf") "ent");;
      #()).

Definition WrBuf__GetEntAt: val :=
  rec: "WrBuf__GetEntAt" "wrbuf" "idx" :=
    let: "ent" := SliceGet (struct.t WrEnt) (struct.loadF WrBuf "ents" "wrbuf") "idx" in
    (struct.get WrEnt "key" "ent", struct.get WrEnt "val" "ent", struct.get WrEnt "del" "ent").

Definition WrBuf__Len: val :=
  rec: "WrBuf__Len" "wrbuf" :=
    slice.len (struct.loadF WrBuf "ents" "wrbuf").

Definition WrBuf__Clear: val :=
  rec: "WrBuf__Clear" "wrbuf" :=
    struct.storeF WrBuf "ents" "wrbuf" (SliceTake (struct.loadF WrBuf "ents" "wrbuf") #0);;
    #().

End code.
