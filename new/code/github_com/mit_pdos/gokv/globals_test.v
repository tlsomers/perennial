(* autogenerated from github.com/mit-pdos/gokv/globals_test *)
From New.golang Require Import defn.

Section code.
Context `{ffi_syntax}.

(* go: globals.go:3:6 *)
Definition foo : val :=
  rec: "foo" <> :=
    exception_do (return: (#(W64 10))).

Definition global_id' : string := "github.com/mit-pdos/gokv/globals_test".

Definition GlobalX : string := global_id' ++ "GlobalX".

Definition globalY : string := global_id' ++ "globalY".

Definition globalA : string := global_id' ++ "globalA".

Definition globalB : string := global_id' ++ "globalB".

(* go: globals.go:12:6 *)
Definition other : val :=
  rec: "other" <> :=
    exception_do (let: "$r0" := #"ok" in
    do:  ((globals.get globalY) <-[stringT] "$r0")).

(* go: globals.go:16:6 *)
Definition bar : val :=
  rec: "bar" <> :=
    exception_do (do:  (other #());;;
    (if: ((![uint64T] (globals.get GlobalX)) ≠ #(W64 10)) || ((![stringT] (globals.get globalY)) ≠ #"ok")
    then
      do:  (let: "$a0" := (interface.make string__mset #"bad") in
      Panic "$a0")
    else do:  #())).

(* go: globals.go:31:6 *)
Definition main : val :=
  rec: "main" <> :=
    exception_do (do:  (bar #())).

Definition define' : val :=
  rec: "define'" <> :=
    exception_do (globals.put globalB (ref_ty stringT (zero_val stringT));;;
    globals.put globalA (ref_ty stringT (zero_val stringT));;;
    globals.put globalY (ref_ty stringT (zero_val stringT));;;
    globals.put GlobalX (ref_ty uint64T (zero_val uint64T))).

Definition initialize' : val :=
  rec: "initialize'" <> :=
    exception_do (if: globals.is_uninitialized global_id'
    then
      do:  (define' #());;;
      let: "$r0" := (foo #()) in
      do:  ((globals.get GlobalX) <-[uint64T] "$r0");;;
      let: "$r0" := #"a" in
      do:  ((globals.get globalA) <-[stringT] "$r0");;;
      let: "$r0" := #"b" in
      do:  ((globals.get globalB) <-[stringT] "$r0");;;
      do:  ((λ: <>,
        exception_do (let: "$r0" := (![uint64T] (globals.get GlobalX)) in
        do:  ((globals.get GlobalX) <-[uint64T] "$r0"))
        ) #());;;
      do:  ((λ: <>,
        exception_do (let: "$r0" := #"" in
        do:  ((globals.get globalY) <-[stringT] "$r0"))
        ) #())
    else do:  #()).

End code.
